#!/bin/sh
# SecuBox Centralized User Management
# Synchronizes users across all SecuBox services

VERSION="1.0.0"
CONFIG="secubox-users"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

log_info()  { echo -e "${GREEN}[USERS]${NC} $1"; }
log_warn()  { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
log_title() { echo -e "\n${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"; echo -e "${BLUE}$1${NC}"; echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"; }

# Load libraries
. /usr/lib/secubox/users-lib.sh 2>/dev/null || true
. /usr/lib/secubox/users-login-stats.sh 2>/dev/null || true

# UCI helpers
uci_get() { uci -q get ${CONFIG}.$1; }
uci_set() { uci -q set ${CONFIG}.$1="$2"; }
uci_add_list() { uci -q add_list ${CONFIG}.$1="$2"; }
uci_commit() { uci commit ${CONFIG}; }

# Get settings
get_domain() { uci_get main.domain || echo "secubox.in"; }
get_matrix_server() { uci_get main.matrix_server || echo "matrix.local"; }

# Generate password hash (SHA256)
hash_password() {
	echo -n "$1" | sha256sum | cut -d' ' -f1
}

# Generate random password
generate_password() {
	head -c 12 /dev/urandom | base64 | tr -dc 'a-zA-Z0-9!@#$%' | head -c 16
}

# Check if service is available
check_service() {
	local service="$1"
	case "$service" in
		nextcloud) [ -x /usr/sbin/nextcloudctl ] && lxc-info -n nextcloud 2>/dev/null | grep -q "RUNNING" ;;
		peertube)  [ -x /usr/sbin/peertubectl ] && lxc-info -n peertube 2>/dev/null | grep -q "RUNNING" ;;
		matrix)    [ -x /usr/sbin/matrixctl ] && lxc-info -n matrix 2>/dev/null | grep -q "RUNNING" ;;
		jabber)    [ -x /usr/sbin/jabberctl ] && lxc-info -n jabber 2>/dev/null | grep -q "RUNNING" ;;
		email)     [ -x /usr/sbin/mailserverctl ] && lxc-info -n mailserver 2>/dev/null | grep -q "RUNNING" ;;
		*) return 1 ;;
	esac
}

# Create user on a specific service
create_on_service() {
	local username="$1"
	local password="$2"
	local service="$3"
	local domain=$(get_domain)
	local matrix_server=$(get_matrix_server)
	local email="${username}@${domain}"

	case "$service" in
		nextcloud)
			export OC_PASS="$password"
			nextcloudctl occ user:add "$username" --password-from-env --display-name="$username" 2>/dev/null
			nextcloudctl occ user:setting "$username" settings email "$email" 2>/dev/null
			;;
		peertube)
			peertubectl admin create-user --username "$username" --email "$email" --password "$password" 2>/dev/null
			;;
		matrix)
			# Enable registration, create user, disable
			local reg_token=$(uci -q get matrix.admin.registration_token)
			curl -s -X POST "http://127.0.0.1:8008/_matrix/client/v3/register" \
				-H "Content-Type: application/json" \
				-d "{\"username\":\"${username}\",\"password\":\"${password}\",\"auth\":{\"type\":\"m.login.registration_token\",\"token\":\"${reg_token}\"}}" >/dev/null 2>&1
			;;
		jabber)
			jabberctl user add "${username}@${domain}" "$password" 2>/dev/null
			;;
		email)
			mailserverctl add-user "$email" "$password" 2>/dev/null
			;;
	esac
}

# Update password on a specific service
update_password_on_service() {
	local username="$1"
	local password="$2"
	local service="$3"
	local domain=$(get_domain)
	local email="${username}@${domain}"

	case "$service" in
		nextcloud)
			export OC_PASS="$password"
			nextcloudctl occ user:resetpassword "$username" --password-from-env 2>/dev/null
			;;
		peertube)
			# PeerTube reset-password sends email, we need direct update
			peertubectl admin reset-password --username "$username" 2>/dev/null
			;;
		matrix)
			# Matrix Conduit doesn't have easy password reset API
			log_warn "Matrix: User must change password via client"
			;;
		jabber)
			jabberctl user passwd "${username}@${domain}" "$password" 2>/dev/null
			;;
		email)
			# Remove and re-add user
			sed -i "/^${email}:/d" /srv/lxc/mailserver/rootfs/etc/dovecot/users 2>/dev/null
			mailserverctl add-user "$email" "$password" 2>/dev/null
			;;
	esac
}

# Delete user from a specific service
delete_from_service() {
	local username="$1"
	local service="$2"
	local domain=$(get_domain)
	local email="${username}@${domain}"

	case "$service" in
		nextcloud)
			nextcloudctl occ user:delete "$username" 2>/dev/null
			;;
		peertube)
			# PeerTube user deletion via API
			log_warn "PeerTube: Manual deletion required via admin panel"
			;;
		matrix)
			# Conduit user deactivation
			log_warn "Matrix: Manual deactivation required via admin room"
			;;
		jabber)
			jabberctl user del "${username}@${domain}" 2>/dev/null
			;;
		email)
			sed -i "/^${email}:/d" /srv/lxc/mailserver/rootfs/etc/dovecot/users 2>/dev/null
			sed -i "/${email}/d" /srv/lxc/mailserver/rootfs/etc/postfix/vmailbox 2>/dev/null
			;;
	esac
}

# Add a new user
cmd_add() {
	local username="$1"
	local password="$2"
	local services="$3"

	if [ -z "$username" ]; then
		log_error "Usage: secubox-users add <username> [password] [services]"
		log_error "  services: nextcloud,peertube,jabber,matrix,email (comma-separated)"
		log_error "  If no password, one will be generated"
		log_error "  If no services, all available services will be used"
		return 1
	fi

	# Generate password if not provided
	if [ -z "$password" ]; then
		password=$(generate_password)
		log_info "Generated password: $password"
	fi

	# Default to all services if not specified
	if [ -z "$services" ]; then
		services=$(uci_get main.default_services || echo "nextcloud peertube jabber matrix email")
	else
		services=$(echo "$services" | tr ',' ' ')
	fi

	local domain=$(get_domain)
	local email="${username}@${domain}"
	local password_hash=$(hash_password "$password")

	log_title "Creating user: $username"
	echo "Email: $email"
	echo "Services: $services"
	echo ""

	# Store in UCI
	uci -q delete ${CONFIG}.${username} 2>/dev/null
	uci -q set ${CONFIG}.${username}=user
	uci_set ${username}.email "$email"
	uci_set ${username}.password_hash "$password_hash"
	uci_set ${username}.enabled '1'
	uci_set ${username}.created "$(date -Iseconds)"

	# Create on each service
	local created=""
	for svc in $services; do
		if check_service "$svc"; then
			log_info "Creating on $svc..."
			if create_on_service "$username" "$password" "$svc"; then
				uci_add_list ${username}.services "$svc"
				created="$created $svc"
				log_info "  $svc: OK"
			else
				log_warn "  $svc: Failed"
			fi
		else
			log_warn "  $svc: Not available"
		fi
	done

	uci_commit

	echo ""
	log_info "User created on:$created"
	echo ""
	echo "╔══════════════════════════════════════════════╗"
	echo "║            USER CREDENTIALS                  ║"
	echo "╠══════════════════════════════════════════════╣"
	printf "║ Username:  %-33s ║\n" "$username"
	printf "║ Password:  %-33s ║\n" "$password"
	printf "║ Email:     %-33s ║\n" "$email"
	echo "╚══════════════════════════════════════════════╝"
}

# Delete a user
cmd_del() {
	local username="$1"

	if [ -z "$username" ]; then
		log_error "Usage: secubox-users del <username>"
		return 1
	fi

	# Check if user exists in UCI
	if ! uci -q get ${CONFIG}.${username} >/dev/null; then
		log_error "User '$username' not found in SecuBox users"
		return 1
	fi

	log_title "Deleting user: $username"

	# Get services
	local services=$(uci -q get ${CONFIG}.${username}.services 2>/dev/null | tr ' ' '\n' | sort -u)

	# Delete from each service
	for svc in $services; do
		if check_service "$svc"; then
			log_info "Deleting from $svc..."
			delete_from_service "$username" "$svc"
		fi
	done

	# Remove from UCI
	uci -q delete ${CONFIG}.${username}
	uci_commit

	log_info "User '$username' deleted"
}

# Update user password
cmd_passwd() {
	local username="$1"
	local password="$2"

	if [ -z "$username" ]; then
		log_error "Usage: secubox-users passwd <username> [new_password]"
		return 1
	fi

	# Check if user exists
	if ! uci -q get ${CONFIG}.${username} >/dev/null; then
		log_error "User '$username' not found"
		return 1
	fi

	# Generate password if not provided
	if [ -z "$password" ]; then
		password=$(generate_password)
		log_info "Generated password: $password"
	fi

	log_title "Updating password for: $username"

	local password_hash=$(hash_password "$password")
	uci_set ${username}.password_hash "$password_hash"

	# Get services
	local services=$(uci -q get ${CONFIG}.${username}.services 2>/dev/null | tr ' ' '\n' | sort -u)

	# Update on each service
	for svc in $services; do
		if check_service "$svc"; then
			log_info "Updating on $svc..."
			update_password_on_service "$username" "$password" "$svc"
		fi
	done

	uci_commit

	echo ""
	echo "╔══════════════════════════════════════════════╗"
	printf "║ Password updated: %-25s ║\n" "$password"
	echo "╚══════════════════════════════════════════════╝"
}

# List users
cmd_list() {
	log_title "SecuBox Users"

	local users=$(uci show ${CONFIG} 2>/dev/null | grep "=user$" | cut -d'.' -f2 | cut -d'=' -f1)
	local domain=$(get_domain)

	if [ -z "$users" ]; then
		echo "No users configured."
		return
	fi

	printf "%-12s %-22s %-18s %6s %6s\n" "USERNAME" "EMAIL" "LAST LOGIN" "OK" "FAIL"
	echo "────────────────────────────────────────────────────────────────────────────"

	for user in $users; do
		local email=$(uci_get ${user}.email)

		# Get login stats if library loaded
		local last_login="n/a"
		local ok_count="0"
		local fail_count="0"

		if type get_user_stats_summary >/dev/null 2>&1; then
			local stats=$(get_user_stats_summary "$user" "$domain" 2>/dev/null)
			last_login=$(echo "$stats" | cut -d'|' -f1)
			ok_count=$(echo "$stats" | cut -d'|' -f2)
			fail_count=$(echo "$stats" | cut -d'|' -f3)
			[ -z "$last_login" ] && last_login="never"
		fi

		printf "%-12s %-22s %-18s %6s %6s\n" "$user" "${email:-$user@$domain}" "${last_login:0:18}" "${ok_count:-0}" "${fail_count:-0}"
	done

	echo ""
	echo "Use 'secubox-users stats <user>' for detailed login statistics"
}

# Show login stats for a user
cmd_stats() {
	local username="$1"

	if [ -z "$username" ]; then
		log_error "Usage: secubox-users stats <username>"
		return 1
	fi

	# Check user exists
	if ! uci -q get ${CONFIG}.${username} >/dev/null 2>&1; then
		log_error "User not found: $username"
		return 1
	fi

	local domain=$(get_domain)
	log_title "Login Statistics: $username"

	echo ""
	printf "%-12s %-24s %8s %8s\n" "SERVICE" "LAST LOGIN" "SUCCESS" "FAILURE"
	echo "────────────────────────────────────────────────────────────────"

	# Nextcloud
	local nc_stats=$(get_nextcloud_stats "$username" 2>/dev/null || echo "||")
	local nc_last=$(echo "$nc_stats" | cut -d'|' -f1)
	local nc_ok=$(echo "$nc_stats" | cut -d'|' -f2)
	local nc_fail=$(echo "$nc_stats" | cut -d'|' -f3)
	printf "%-12s %-24s %8s %8s\n" "Nextcloud" "${nc_last:-never}" "${nc_ok:-0}" "${nc_fail:-0}"

	# PeerTube
	local pt_stats=$(get_peertube_stats "$username" 2>/dev/null || echo "||")
	local pt_last=$(echo "$pt_stats" | cut -d'|' -f1)
	local pt_ok=$(echo "$pt_stats" | cut -d'|' -f2)
	local pt_fail=$(echo "$pt_stats" | cut -d'|' -f3)
	printf "%-12s %-24s %8s %8s\n" "PeerTube" "${pt_last:-never}" "${pt_ok:-0}" "${pt_fail:-0}"

	# Jabber
	local jb_stats=$(get_jabber_stats "$username" "$domain" 2>/dev/null || echo "||")
	local jb_last=$(echo "$jb_stats" | cut -d'|' -f1)
	local jb_ok=$(echo "$jb_stats" | cut -d'|' -f2)
	local jb_fail=$(echo "$jb_stats" | cut -d'|' -f3)
	printf "%-12s %-24s %8s %8s\n" "Jabber" "${jb_last:-never}" "${jb_ok:-0}" "${jb_fail:-0}"

	# Matrix
	local mx_stats=$(get_matrix_stats "$username" 2>/dev/null || echo "||")
	local mx_last=$(echo "$mx_stats" | cut -d'|' -f1)
	local mx_ok=$(echo "$mx_stats" | cut -d'|' -f2)
	local mx_fail=$(echo "$mx_stats" | cut -d'|' -f3)
	printf "%-12s %-24s %8s %8s\n" "Matrix" "${mx_last:-never}" "${mx_ok:-0}" "${mx_fail:-0}"

	# Email
	local em_stats=$(get_email_stats "$username" "$domain" 2>/dev/null || echo "||")
	local em_last=$(echo "$em_stats" | cut -d'|' -f1)
	local em_ok=$(echo "$em_stats" | cut -d'|' -f2)
	local em_fail=$(echo "$em_stats" | cut -d'|' -f3)
	printf "%-12s %-24s %8s %8s\n" "Email" "${em_last:-never}" "${em_ok:-0}" "${em_fail:-0}"

	echo "────────────────────────────────────────────────────────────────"

	# Totals
	local total_ok=$((${nc_ok:-0} + ${pt_ok:-0} + ${jb_ok:-0} + ${mx_ok:-0} + ${em_ok:-0}))
	local total_fail=$((${nc_fail:-0} + ${pt_fail:-0} + ${jb_fail:-0} + ${mx_fail:-0} + ${em_fail:-0}))
	printf "%-12s %-24s %8s %8s\n" "TOTAL" "" "$total_ok" "$total_fail"
	echo ""
}

# Sync user to services (re-create if missing)
cmd_sync() {
	local username="$1"

	if [ -z "$username" ]; then
		# Sync all users
		local users=$(uci show ${CONFIG} 2>/dev/null | grep "=user$" | cut -d'.' -f2 | cut -d'=' -f1)
		for user in $users; do
			cmd_sync "$user"
		done
		return
	fi

	log_title "Syncing user: $username"

	# This would re-verify user exists on all configured services
	log_warn "Sync functionality requires stored password - use 'passwd' to reset"
}

# Show status
cmd_status() {
	log_title "SecuBox User Management v${VERSION}"

	echo ""
	echo "Configuration:"
	echo "  Domain:        $(get_domain)"
	echo "  Matrix Server: $(get_matrix_server)"
	echo ""

	echo "Available Services:"
	for svc in nextcloud peertube jabber matrix email; do
		if check_service "$svc"; then
			echo -e "  ${GREEN}●${NC} $svc"
		else
			echo -e "  ${RED}○${NC} $svc (not running)"
		fi
	done

	echo ""
	local user_count=$(uci show ${CONFIG} 2>/dev/null | grep -c "=user$" || echo 0)
	echo "Users: $user_count"
}

# Show help
show_help() {
	cat << EOF
SecuBox Centralized User Management v${VERSION}

Usage: secubox-users <command> [options]

Commands:
  add <user> [pass] [services]  Create user on all/specified services
  del <user>                    Delete user from all services
  passwd <user> [new_pass]      Update password on all services
  list                          List all users with login stats
  stats <user>                  Show detailed login statistics
  sync [user]                   Sync user(s) to services
  status                        Show status and available services

Services (comma-separated):
  nextcloud, peertube, jabber, matrix, email

Examples:
  secubox-users add alice                    # All services, generated password
  secubox-users add bob MyPass123            # All services, specified password
  secubox-users add carol Pass nextcloud,email  # Only Nextcloud and Email
  secubox-users passwd alice NewPass456      # Update password everywhere
  secubox-users del bob                      # Remove from all services

EOF
}

# Main
case "$1" in
	add)     shift; cmd_add "$@" ;;
	del|delete|remove) shift; cmd_del "$@" ;;
	passwd|password) shift; cmd_passwd "$@" ;;
	list|ls) cmd_list ;;
	sync)    shift; cmd_sync "$@" ;;
	status)  cmd_status ;;
	stats)   shift; cmd_stats "$@" ;;
	help|--help|-h|'') show_help ;;
	*)       log_error "Unknown command: $1"; show_help; exit 1 ;;
esac
